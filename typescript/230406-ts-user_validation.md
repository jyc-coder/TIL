Ïù¥Ï†ÑÏóê ÏÇ¨Ïö©ÌñàÎçò ÏÑúÎ≤Ñ ÌååÏùºÏùÑ ÏÇ¨Ïö©Ìï¥ÏÑú Ïú†Ï†ÄÏù∏Ï¶ùÏùÑ Íµ¨ÌòÑÌïúÎã§.

## Typescript Î°ú Ïú†Ï†Ä Ïù∏Ï¶ù Íµ¨ÌòÑ



### 1) Î∞±ÏóîÎìú API

https://github.com/jyc-coder/typescriptServer
Ìï¥Îãπ Î¶¨Ìè¨ÏßÄÌÜ†Î¶¨ÏóêÏÑú serverÎ•º Ï∞∏Í≥†Ìï† Í≤É 


Î∞±ÏóîÎìúÏùò dbÎäî ÏïÑÎûòÏôÄ Í∞ôÎã§
![](https://velog.velcdn.com/images/jhs000123/post/f02d44df-1f2e-4acd-9ab3-e02bb498a7ae/image.png)

API Î™ÖÏÑ∏ÏÑúÎäî Îã§ÏùåÍ≥º Í∞ôÎã§.
https://www.notion.so/6d89c07b18794207835de1a6cebfa591?v=f551d89a29f14debb9966992478dbb8c


### 2) api ÏÑ§Ï†ïÌïòÍ∏∞ (react-query)(apis, interfaces,utils)

react-queryÏôÄ react-cookie ÏÑ§Ïπò

> yarn add react-query react-cookie


- Ïø†Í∏∞ util Ìï®Ïàò ÏûëÏÑ±

Ïø†ÌÇ§Ïùò ÏÑ§Ï†ï, Ï†úÍ±∞ Îì±ÏùÑ ÏúÑÌï¥ÏÑú `react-cookie`Î™®ÎìàÏùÑ ÌôúÏö©ÌïúÎã§.

`utils/cookies.ts`

```tsx
import { Cookies } from 'react-cookie'
import { Cookie, CookieSetOptions } from 'universal-cookie'

const cookies = new Cookies()

export const getCookie = (name: string) => {
    try {
        return cookies.get(name)
    } catch (error) {
        console.error(error)
    }
}

export const setCookie = (name: string, value: Cookies, option?: CookieSetOptions) => {
    try {
        cookies.set(name, value, { ...option })
    } catch (error) {
        console.error(error)
    }
}

export const removeCookie = (name: string, option?: CookieSetOptions) => {
    try {
        cookies.remove(name, { ...option })
    } catch (error) {
        console.error(error)
    }
}

```
Ïù¥Ï†ú Ïª¥Ìè¨ÎÑåÌä∏ÏóêÏÑú Ìï¥Îãπ Ìï®ÏàòÎì§ÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú ÏÇ¨Ïö©Ìï† Í≤ÉÏù¥Îã§.

- axios ÏÑ§Ï†ïÌïòÍ∏∞

Ïö∞ÏÑ† Ïö∞Î¶¨ ÏÑúÎ≤Ñ URLÏùÑ ÌôòÍ≤Ω Î≥ÄÏàòÎ°ú ÏûëÏÑ±Ìï† Í≤ÉÏù¥Îã§. 

`.env`
```
VITE_SERVER_URL = 'http://localhost:3000/'
```

`apis/axios.ts`
```tsx
import axios, { AxiosError, AxiosRequestConfig } from 'axios'
import { getCookie } from '../utils/cookies'

const getAxiosInstance = () => {
    const config: AxiosRequestConfig = {
        baseURL: import.meta.env.VITE_SERVER_URL,
        headers: {
            'Content-Type': 'application/json',
        },
        withCredentials: true,
    }

    const instance = axios.create(config) // instance: AxiosInstanceÎ°ú ÌÉÄÏûÖ Ï∂îÎ°†
    instance.defaults.timeout = 3000
    instance.interceptors.request.use(
        (request) => {
            const token = getCookie('accessToken')
            if (token) request.headers['Authorization'] = `Bearer ${token}`
            return request
        },
        (error: AxiosError) => {
            console.log(error)
            return Promise.reject(error)
        },
    )
    return instance
}

export const axiosInstance = getAxiosInstance()

```

Î°úÍ∑∏Ïù∏, ÌöåÏõêÍ∞ÄÏûÖÏù¥ Íµ¨ÌòÑÎêú ÏÉÅÌÉúÎùºÎ©¥, ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇº Îïå ÌÜ†ÌÅ∞Í∞íÎèÑ Ìï®Íªò Î≥¥ÎÇ¥Ï£ºÏñ¥Ïïº ÌïúÎã§. (Í∑∏Î†áÍ≤å Ìï¥ÏïºÎßå Î∞±ÏóîÎìúÏóêÏÑú Ïù∏Ï¶ù Ïó¨Î∂ÄÎ•º ÌôïÏù∏Ìï†Ïàò ÏûàÎã§.)

Í∑∏Î†áÍ∏∞ ÎïåÎ¨∏Ïóê instanceÎ•º ÎßåÎì§Î©¥ÏÑú, Ïù∏ÌÑ∞ÏÖâÌÑ∞ ÌòïÌÉúÎ°ú ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇº ÎïåÎßàÎã§ Ïø†ÌÇ§Ïóê Ï†ÄÏû•Îêú ÌÜ†ÌÅ∞ÏùÑ Í∞ÄÏ†∏ÏôÄÏÑú Î≥¥ÎÇ¥ÎèÑÎ°ù ÏûëÏÑ±Ìï¥Ï§ÄÎã§. (ÎòêÌïú withCredentials: trueÎ°ú ÏÑ§Ï†ïÌï¥ÏÑú Î∞±ÏóîÎìúÏóêÏÑú Ïø†ÌÇ§Î•º ÏÑ§Ï†ïÌï†Ïàò ÏûàÎèÑÎ°ù Ìï¥Ï§ÄÎã§.)
ÏïûÏúºÎ°úÎäî ÏúÑÏóêÏÑú ÏûëÏÑ±Ìïú `axiosInstance`Î•º ÌôúÏö©Ìï¥ÏÑú ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇº ÏòàÏ†ïÏù¥Îã§. 

- ÏöîÏ≤≠ Î≥Ñ Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖ Î∞è ÏøºÎ¶¨ Ìï®Ïàò ÏûëÏÑ±ÌïòÍ∏∞ 
ÏöîÏ≤≠Ïóê ÌïÑÏöîÌïú Îç∞Ïù¥ÌÑ∞Îäî Î¨¥ÏóáÏù∏ÏßÄ, Ï†úÎåÄÎ°ú ÏùëÎãµÏù¥ ÏôîÎã§Î©¥ Ïñ¥Îñ§ ÌòïÌÉúÏùò Îç∞Ïù¥ÌÑ∞Í∞Ä Ïò§ÎäîÏßÄÏóê ÎåÄÌï¥ÏÑú ÎØ∏Î¶¨ ÌÉÄÏûÖÏùÑ ÎßåÎì§Ïñ¥ÎÜìÏùÑ Í≤ÉÏù¥Îã§. 

Î≥¥ÌÜµÏùÄ ÏöîÏ≤≠Î≥Ñ Request, Response ÎßàÎã§ ÌÉÄÏûÖÏùÑ ÏßÄÏ†ïÌï¥ÎÜìÍ≤å ÎêòÎäîÎç∞, ÏßÄÍ∏àÍ∞ôÏùÄ Í≤ΩÏö∞ÏóêÎäî REsponse Îç∞Ïù¥ÌÑ∞Î°∏ ÌîÑÎ°†Ìä∏ÏóêÏÑú ÏÇ¨Ïö©Ìï† Post ÏûêÏ≤¥Ïùò Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖÏù¥ ÏùºÏπòÌïòÍ∏∞ ÎïåÎ¨∏Ïóê ÏïÑÎûòÏ≤òÎüº ÎßåÎì§Ïñ¥Ï§ÄÎã§. 

(ÌòπÏãúÎÇò ÌîÑÎ°†Ìä∏ÏóîÎìúÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî Îç∞Ïù¥ÌÑ∞ÏôÄ, Î¶¨Ïä§Ìè∞Ïä§Î°ú Ïò§Îäî Îç∞Ïù¥ÌÑ∞Í∞Ä Îã§Î•¥Îã§Î©¥ ResponseÌÉÄÏûÖÏùÑ Îî∞Î°ú ÎßåÎì§Ïñ¥Ï£ºÎ©¥ÎêúÎã§. )

`interfaces/post.ts`
[O
```tsx
export interface PostRequest {
    title: string
    body: string
}

export interface Post extends PostRequest {
    id: number
    userId: number
}

```

`interfaces/auth.ts`

```tsx
export interface LoginRequest {
    username: string
    password: string
}

export interface RegisterRequest extends LoginRequest {
    email: string
}

export interface UserPayload {
    id: number
    username: string
    email: string
}

export interface AuthResponse extends UserPayload{
  iat: number
  exp: number
  accessToken : string
}

//ÌîÑÎ°†Ìä∏ÏóêÏÑú Îî∞Î°ú Í¥ÄÎ¶¨ÌïòÍ≥†Ïûê ÌïòÎäî Ïú†Ï†Ä Îç∞Ïù¥ÌÑ∞ ÌÉÄÏûÖÏù¥ ÏûàÎã§Î©¥, ÌÉÄÏûÖÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏãúÎ©¥ Îê©ÎãàÎã§.
```

`react-query`ÏóêÏÑú ÏÇ¨Ïö©Ìï† ÏøºÎ¶¨ Ìï®ÏàòÎ•º ÎßåÎì§ÌÖêÎç∞, Ïù¥Î≤àÏóêÎäî Ï†ïÌôïÌûà Ïñ¥Îñ§ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïò§ÎäîÏßÄÎ•º ÏøºÎ¶¨ Ìï®ÏàòÏóêÏÑú ÏßÄÏ†ïÌïúÎã§. 

Ïù¥Î†áÍ≤å ÎØ∏Î¶¨ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞Ïùò ÌÉÄÏûÖÏùÑ ÏßÄÏ†ïÌï¥ÎÜìÏúºÎ©¥, ÌÉÄÏûÖ Ï∂îÎ°†Ïù¥ Ïûò ÏûëÎèôÌïòÍ∏∞ ÎïåÎ¨∏Ïóê Íµ≥Ïù¥ useQueryÎ•º ÏÇ¨Ïö©Ìï† Îïå ÌÉÄÏûÖÏùÑ ÏßÄÏ†ïÌïòÏßÄ ÏïäÏïÑÎèÑ ÎêúÎã§.

`apis/services/post.ts`

```tsx
import { Post, PostRequest } from '../../interfaces/post'
import { axiosInstace } from '../axios'

export const getPosts = async () => {
  try {
    const { data } = await axiosInstace.get<Post[]>('/api/posts')
    return data
  } catch (error) {
    console.log(error)
  }
}

export const createPost = async (post: PostRequest) => {
  try {
    const { data } = await axiosInstace.post<Post>('/api/posts', post)
    return data
  } catch (error) {
    console.log(error)
  }
}
```

`api/services/auth.ts`
```tsx
import { AuthResponse, LoginRequest, RegisterRequest, UserPayload } from '../../interfaces/auth'
import { axiosInstance } from '../axios'

export const login = async (user: LoginRequest) => {
    try {
        const { data } = await axiosInstance.post<AuthResponse>('/api/auth/login', user)
        return data
    } catch (error) {
        console.log(error)
    }
}

export const register = async (user: RegisterRequest) => {
    try {
        const { data } = await axiosInstance.post<AuthResponse>('/api/auth/register', user)
        return data
    } catch (error) {
        console.log(error)
    }
}


export const verify = async () => {
  try {
    const { data } = await axiosInstance.get<UserPayload>('/api/auth/verify')
    return data
  } catch (error) {
    console.log(error)
  }
}
```

Ïù¥Î†áÍ≤å Ìï¥Ï£ºÍ≥† app.tsxÏóê react query ÏÑ∏ÌåÖÏùÑ Ìï¥Ï§ÄÎã§.

`app.tsx`
```tsx
import './App.css'
import { QueryClientProvider, QueryClient } from 'react-query'

function App() {
    const queryClient = new QueryClient({
        defaultOptions: {
            queries: {
                refetchOnWindowFocus: false,
            },
        },
    })
    return <QueryClientProvider client={queryClient}></QueryClientProvider>
}

export default App

```

Ïù¥Ï†ú Ïª¥Ìè¨ÎÑåÌä∏Î•º ÎßåÎì§Ïñ¥Î≥¥Ïûê.

### 3)compoennt ÏÉùÏÑ±ÌïòÍ∏∞
ÏûëÏùÄ Îã®ÏúÑÎ°ú Ïª¥Ìè¨ÎÑåÌä∏Î•º ÏÉùÏÑ±ÌïòÍ≥†, Ìï¥Îãπ Ïª¥Ìè¨ÎÑåÌä∏Î•º Ïù¥Ïö©Ìï¥ÏÑú ÌéòÏù¥ÏßÄÎ•º Íµ¨ÏÑ±Ìï¥Î≥¥Ïûê.

- login -> loginform Ïª¥Ìè¨ÎÑåÌä∏
- posts -> postform, postlist Ïª¥Ìè¨ÎÑåÌä∏

- login Ïª¥Ìè¨ÎÑåÌä∏
`login/LoginForm/index.jsx`

```tsx
import React, { useState } from 'react'
import { UseMutateFunction } from 'react-query'
import { AxiosError } from 'axios'
import { LoginRequest, AuthResponse } from '../../../interfaces/auth'
interface LoginFormProps {
    mutate: UseMutateFunction<AuthResponse, AxiosError, LoginRequest>
}
function LoginForm({ mutate }: LoginFormProps) {
    const [userInput, setUserInput] = useState<LoginRequest>({ username: '', password: '' })
    const onChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target
        setUserInput({ ...userInput, [name]: value })
    }
    const onSubmit = (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        mutate(userInput)
    }
    return (
        <form onSubmit={onSubmit}>
            <input type="text" name="username" value={userInput.username} onChange={onChange} />
            <input type="password" name="password" value={userInput.password} onChange={onChange} />
            <button type="submit">Î°úÍ∑∏Ïù∏</button>
        </form>
    )
}

export default LoginForm

```

- post Ïª¥Ìè¨ÎÑåÌä∏
`posts/PostList/index.js`
```tsx
import React from 'react'
import { Post } from '../../../interfaces/post'

interface PostListProps {
    posts: Post[]
}

function PostList({ posts }: PostListProps) {
    return (
        <>
            {posts.map((post) => (
                <div key={post.id}>
                    <h2>{post.title}</h2>
                    <p>{post.body}</p>
                    <p>ÏûëÏÑ±Ïûê: {post.userId}</p>
                </div>
            ))}
        </>
    )
}

export default PostList

```

`post/PostForm/index.tsx`

```tsx
import React, { useState } from 'react'
import { Post, PostRequest } from '../../../interfaces/post'
import { AxiosError } from 'axios'
import { UseMutateFunction } from 'react-query'

interface PostFormProps {
    mutate: UseMutateFunction<Post, AxiosError, PostRequest>
}

function PostForm({ mutate }: PostFormProps) {
    const [userInput, setUserInput] = useState<PostRequest>({ title: '', body: '' })
    const onChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        const { name, value } = e.target
        setUserInput({ ...userInput, [name]: value })
    }
    const onSubmit = (e: React.FormEvent<HTMLFormElement>) => {
        e.preventDefault()
        mutate(userInput)
    }

    return (
        <form onSubmit={onSubmit}>
            <input type="text" name="title" value={userInput.title} onChange={onChange} />
            <input type="text" name="body" value={userInput.body} onChange={onChange} />
            <button type="submit">ÏûëÏÑ±ÌïòÍ∏∞</button>
        </form>
    )
}

export default PostForm

```


### 4) page ÏÑ§Ï†ïÌïòÍ∏∞ (pages, routes)


> yarn add react-router-dom
yarn add @types/react-router-dom

page ÏôÄ routeÎäî ÏïÑÎûòÏôÄ Í∞ôÏù¥ Íµ¨ÏÑ±ÌïúÎã§

- /login -> Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄ
- /posts -> Í∏Ä Î¶¨Ïä§Ìä∏
- /posts/new -> Í∏Ä ÏûëÏÑ±

`pages/LoginPage.tsx`
```tsx
import React from 'react'
import LoginForm from '../components/LoginForm'
import { useMutation } from 'react-query'
import { login } from '../apis/services/auth'
import { AxiosError } from 'axios'
import { setCookie } from '../utils/cookies'
import { useNavigate } from 'react-router-dom'

function LoginPage() {
  const navigate = useNavigate()
  const { mutate } = useMutation(login, {
    onSuccess: (data) => {
      setCookie('accessToken', data.accessToken, { path: '/', maxAge: data.exp - data.iat })
      navigate('/posts') // Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ Ïãú Ïù¥Îèô
    },
    onError: (err: AxiosError) => {
      console.log(err)
    },
  }) // ÏóêÎü¨ ÌÉÄÏûÖ Ï∂îÎ°†Ìï† Ïàò ÏûàÎèÑÎ°ù ÏÑ§Ï†ï

  return <LoginForm mutate={mutate} />
}

export default LoginPage
```

`pages/PostsPage.tsx`

```tsx
import React from 'react'
import { useQuery } from 'react-query'
import { getPosts } from '../apis/services/post'
import PostList from '../components/PostList'

function PostsPage() {
  const { data: posts, isLoading, error } = useQuery('posts', getPosts)

  if (isLoading) return <>Î°úÎî© Ï§ë</>
  if (error || !posts) return <>ÏóêÎü¨ Î∞úÏÉù</>
  return <PostList posts={posts} />
}

export default PostsPage
```

`pages/PostCreatePage.tsx`

```tsx
import React from 'react'
import PostForm from '../components/PostForm'
import { useMutation } from 'react-query'
import { createPost } from '../apis/services/post'
import { AxiosError } from 'axios'
import { useNavigate } from 'react-router-dom'

function PostCreatePage() {
  const navigate = useNavigate()
  const { mutate } = useMutation(createPost, {
    onSuccess: () => {
      navigate('/posts') // Í∏Ä ÏûëÏÑ± ÏÑ±Í≥µ Ïãú Ïù¥Îèô
    },
    onError: (err: AxiosError) => {
      console.log(err)
    },
  })

  return <PostForm mutate={mutate} />
}

export default PostCreatePage
```

`routes/Router.tsx`
```tsx
import React from 'react'
import { BrowserRouter, Route, Routes } from 'react-router-dom'
import LoginPage from '../pages/LoginPage'
import PostCreatePage from '../pages/PostCreatePage'
import PostsPage from '../pages/PostsPage'

function Router() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/login" element={<LoginPage />} />
        <Route path="/posts" element={<PostsPage />} />
        <Route path="/posts/new" element={<PostCreatePage />} />
      </Routes>
    </BrowserRouter>
  )
}

export default Router
```

ÌòÑÏû¨Îäî Î™®Îì† route Í∞Ä Î°úÍ∑∏Ïù∏ÏùÑ ÏïàÌï¥ÎèÑ Ï†ëÍ∑ºÏù¥ Í∞ÄÎä•ÌïòÏßÄÎßå, Ïù¥Ï†ú Î°úÍ∑∏Ïù∏ Ïó¨Î∂ÄÎ•º Í≤ÄÏ¶ùÌïòÎäî Î°úÏßÅÏùÑ Ï∂îÍ∞ÄÌïòÎ†§Í≥† ÌïúÎã§. 
`app.tsx`
```tsx
import { QueryClient, QueryClientProvider } from 'react-query'
import Router from './routes/Router'

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
    },
  },
})

function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <Router />
    </QueryClientProvider>
  )
}

export default App
```


### 5) token Í≤ÄÏ¶ù Í¥ÄÎ†® Ï∂îÍ∞Ä ÏÑ§Ï†ï(hooks)

`ÌÜ†ÌÅ∞ Í≤ÄÏ¶ù`ÏùÄ Îß§Ïö∞ Ï§ëÏöîÌïòÎã§. Îã®ÏàúÌûà ÌÜ†ÌÅ∞Ïù¥ ÏûàÎã§Í≥† Ìï¥ÏÑú ÌäπÏ†ïÌïú ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÏù¥ Í∞ÄÎä•ÌïòÎèÑÎ°ù ÌïúÎã§Î©¥, Î≥¥ÏïàÏÉÅÏùò Î¨∏Ï†úÍ∞Ä ÏÉùÍ∏∏ Ïàò ÏûàÎã§.
Í∑∏Î†áÍ∏∞ ÎïåÎ¨∏Ïóê ÌòÑÏû¨ Ïú†Ï†ÄÏùò ÌÜ†ÌÅ∞Ïù¥ Ï†ïÎßê Ïú†Ìö®Ìïú ÌÜ†ÌÅ∞Ïù∏ÏßÄ(Ïö∞Î¶¨Í∞Ä Î∞úÍ∏âÌï¥Ï§Ä ÌÜ†ÌÅ∞Ïù¥ ÎßûÎäîÏßÄ, Ïú†Ìö®Í∏∞Í∞ÑÏù¥ ÏßÄÎÇúÍ±¥ ÏïÑÎãåÏßÄ) Îì±ÏùÑ Ï†êÍ≤ÄÌïòÍ≥†, ÌòπÏãúÎÇò Ïú†Ìö®ÌïòÏßÄ ÏïäÎã§Î©¥ Ï†ëÍ∑ºÌïòÏßÄ Î™ªÌïòÎèÑÎ°ù ÌïòÎäî Î°úÏßÅÏù¥ ÌïÑÏöîÌïòÎã§.

ÌÜ†ÌÅ∞ Í≤ÄÏ¶ùÏùÑ ÏúÑÌïú ÌõÖ(verifyToken)ÏùÑ ÎßåÎì§Ïñ¥ÏÑú ÏÇ¨Ïö©Ìï¥Î≥¥Ïûê.

`hooks/verifyToken.tsx`

```tsx
import React, { useState } from 'react'
import { useQuery } from 'react-query'
import { verify } from '../apis/services/auth'
import { getCookie } from '../utils/cookies'

type authType = 'PENDING' | 'SUCCESS' | 'FAILED'

function verifyToken() {
  const [isAuthenticated, setIsAuthenticated] = useState<authType>('PENDING')
  const verifyResult = useQuery(['auth', 'verify'], verify, {
    onSuccess: () => {
      setIsAuthenticated('SUCCESS')
    },
    onError: () => {
      setIsAuthenticated('FAILED')
    },
    retry: 0, // Ïã§Ìå®ÌñàÎçîÎùºÎèÑ Îã§Ïãú ÏöîÏ≤≠ÌïòÏßÄ ÏïäÏùå
    enabled: !!getCookie('accessToken'), // ÌÜ†ÌÅ∞Ïù¥ ÏûàÏùÑ ÎïåÎßå verify
  }) // Ïø†ÌÇ§Í∞Ä ÏóÜÏúºÎ©¥ undefined ÎùºÏÑú, boolean ÌÉÄÏûÖÏúºÎ°ú Î≥ÄÌôòÌïòÍ∏∞ ÏúÑÌï¥ !! ÏÇ¨Ïö©

  return isAuthenticated // Ïù∏Ï¶ù Ïó¨Î∂Ä Í∞íÏùÑ Î¶¨ÌÑ¥Ìï¥ÏÑú ÏÇ¨Ïö©
}

export default verifyToken
```

Ïù¥Ï†ú Í∞ÄÏ†∏Ïò® `isAuthenticated`Í∞íÏùÑ Í∞ÄÏßÄÍ≥†, ÌéòÏù¥ÏßÄ Ï†ëÍ∑º Í∞ÄÎä• Ïó¨Î∂ÄÎ•º ÌåêÎã®ÌïòÎäî Î°úÏßÅÏùÑ `ProtectedRouter`Ïóê ÏûëÏÑ±ÌïúÎã§.

`router/ProtectedRouter.tsx`
```tsx

import React, { useEffect } from 'react'
import verifyToken from '../hooks/verifyToken'
import { getCookie } from '../utils/cookies'
import { Outlet, useNavigate } from 'react-router-dom'

export default function ProtectedRouter() {
    const isAuthenticated = verifyToken()
    const token = getCookie('accessToken')
    const navigate = useNavigate()

    useEffect(() => {
        if (!token || isAuthenticated === 'FAILED') {
            //ÌÜ†ÌÅ∞Ïù¥ ÏóÜÍ±∞ÎÇò, Ïù∏Ï¶ù Ïã§Ìå® Ïãú Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú
            alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§')
            navigate('/login')
        }
    }, [isAuthenticated])

    return <Outlet />
}

```

Ïù¥Ï†ú Ïù¥ ÎùºÏö∞ÌÑ∞Î°ú Í∞êÏã∏Îäî ÌéòÏù¥ÏßÄÎäî Ìï≠ÏÉÅ ÌÜ†ÌÅ∞ Î∞è isAuthenticatedÎ•º ÌÜ†ÎåÄÎ°ú Ïú†Ìö®Ìïú ÌÜ†ÌÅ∞Ïù¥ ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå Ï†ëÍ∑ºÌï†Ïàò ÏûàÎã§.
`routes/Router.tsx`
```tsx
import { BrowserRouter, Route, Routes } from 'react-router-dom'
import LoginPage from '../pages/LoginPage'
import PostCreatePage from '../pages/PostCreatePage'
import PostsPage from '../pages/PostsPage'
import ProtectedRouter from './ProtectedRouter'

function Router() {
    return (
        <BrowserRouter>
            <Routes>
                <Route path="/login" element={<LoginPage />} />
                <Route path="/posts" element={<PostsPage />} />
                <Route element={<ProtectedRouter />}>
                    <Route path="/post/new" element={<PostCreatePage />} />
                </Route>
            </Routes>
        </BrowserRouter>
    )
}

export default Router

```

Ïù¥Ï†ú PostCreateÎäî Î°úÍ∑∏Ïù∏ÏùÑ Ìï¥ÏÑú Ïú†Ìö®Ìïú ÌÜ†ÌÅ∞Ïù¥ Ïø†ÌÇ§Ïóê ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎã§.


### 6) token refresh ÏÑ§Ï†ï

ÎßåÏïΩ access token Ïù¥ ÎßåÎ£åÎêòÏñ¥ÏÑú ÏóÜÍ≥†, refresh token Îßå Ïø†ÌÇ§Ïóê Ï°¥Ïû¨ÌïòÎäî ÏÉÅÌô©Ïù¥ÎùºÎ©¥?
Í∑∏ÎïåÎäî ÏûêÎèôÏúºÎ°ú refresh ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ¥Í≥† access tokenÏùÑ Ïû¨Î∞úÍ∏â Î∞õÎèÑÎ°ù Ìï¥Ï§òÏïºÌïúÎã§. 


Ïö∞ÏÑ† refresh ÏøºÎ¶¨ Ìï®ÏàòÎ•º ÏûëÏÑ±ÌïúÎã§.

`apis/services/auth.ts`

```tsx
import { useState } from 'react'
import { useQuery } from 'react-query'
import { refresh, verify } from '../apis/services/auth'
import { getCookie, setCookie } from '../utils/cookies'

type authType = 'PENDING' | 'SUCCESS' | 'FAILED'

function verifyToken() {
    const [isAuthenticated, setIsAuthenticated] = useState<authType>('PENDING')
    const verifyResult = useQuery(['auth', 'verify'], verify, {
        onSuccess: () => {
            setIsAuthenticated('SUCCESS')
        },
        onError: () => {
            setIsAuthenticated('FAILED')
        },
        retry: 0,
        enabled: !!getCookie('accessToken'), // ÌÜ†ÌÅ∞Ïù¥ ÏûàÏùÑ ÎïåÎßå verify
    }) // Ïø†ÌÇ§Í∞Ä ÏóÜÏúºÎ©¥ undefinedÎùºÏÑú, boolean ÌÉÄÏûÖÏúºÎ°ú Î≥ÄÌôòÌïòÍ∏∞ ÏúÑÌï¥ÏÑú !!Î•º ÏÇ¨Ïö©ÌïúÎã§.

    // Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏùÑ ÎïåÎßå
    // Í∞ÄÎä•ÌïòÎã§Î©¥, refresh tokenÏùò Ï°¥Ïû¨ Ïó¨Î∂ÄÎ•º Ïø†ÌÇ§ ÌòπÏùÄ redux ÏÉÅÌÉúÎ°ú Í¥ÄÎ¶¨ÌïòÎ©¥ÏÑú Ìï®Íªò Ïç®Ï£ºÎäî Í≤ÉÏù¥ Ï¢ãÎã§.
    const refreshResult = useQuery(['auth', 'refresth'], refresh, {
        onSuccess: (data) => {
            setCookie('accessToken', data.accessToken, { path: '/', maxAge: data.exp - data.iat })
            setIsAuthenticated('SUCCESS')
        },
        onError: () => {
            setIsAuthenticated('FAILED')
        },
        retry: 0,
        enabled: !getCookie('accessToken'),
    })
    return isAuthenticated
}

export default verifyToken

```

`ProtectedRouter`Ï™ΩÏóêÏÑú, ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏúºÎ©¥ Î∞îÎ°ú Î°úÍ∑∏Ïù∏ÏùÑ ÎÑòÍ∏∞Îçò Î°úÏßÅÏùÄ Ï†úÏô∏ÌïúÎã§.

`routes/ProtectedRouter.tsx`
```tsx
import React, { useEffect } from 'react'
import verifyToken from '../hooks/verifyToken'
import { Outlet, useNavigate } from 'react-router-dom'

function ProtectedRouter() {
  const isAuthenticated = verifyToken()
  const navigate = useNavigate()

  useEffect(() => {
    if (isAuthenticated === 'FAILED') {
      // Ïù¥Ï†ú ÌÜ†ÌÅ∞Ïù¥ ÏûàÎì† ÏóÜÎì† isAuthenticated Îäî Í∞íÏù¥ set ÎêòÎØÄÎ°ú token ÏùÄ Ï°∞Í±¥Î¨∏ÏóêÏÑú Ï†úÏô∏
      // Ïù∏Ï¶ù Ïã§Ìå® Ïãú Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú
      alert('Î°úÍ∑∏Ïù∏ Ìï¥Ï£ºÏÑ∏Ïöî')
      navigate('/login')
    }
  }, [isAuthenticated])

  return <Outlet />
}

export default ProtectedRouter
```

Ïù¥Ï†ú Îã§ ÎêêÎã§Í≥† ÏÉùÍ∞ÅÌñàÍ≤†ÏßÄÎßå ÏïÑÏßÅ Î¨∏Ï†úÍ∞Ä ÏûàÎã§. 
ÎùºÏö∞ÌÑ∞Î•º ÏïÑÎûòÏ≤òÎüº ÏàòÏ†ïÌï¥Î≥¥Ïûê.

```tsx
import React from 'react'
import { BrowserRouter, Route, Routes } from 'react-router-dom'
import LoginPage from '../pages/LoginPage'
import PostCreatePage from '../pages/PostCreatePage'
import PostsPage from '../pages/PostsPage'
import ProtectedRouter from './ProtectedRouter'
import { Link } from 'react-router-dom'

function Router() {
  return (
    <BrowserRouter>
      <nav>
        <Link to="/posts">Ìè¨Ïä§Ìä∏</Link> | <Link to="/posts/new">ÏÉà Í∏Ä</Link>
      </nav>
      <Routes>
        <Route path="/login" element={<LoginPage />} />
        <Route element={<ProtectedRouter />}>
          <Route path="/posts" element={<PostsPage />} />
          <Route path="/posts/new" element={<PostCreatePage />} />
        </Route>
      </Routes>
    </BrowserRouter>
  )
}

export default Router
```

1. ÏßÄÍ∏àÏùÄ react query Ï™ΩÏóêÏÑú accessTokenÏùò Ï°¥Ïû¨ Ïó¨Î∂ÄÎßåÏùÑ Î∞îÎùºÎ≥¥Í≥† ÏûàÏñ¥ÏÑú, accessToken Ïù¥ ÏàòÏ†ïÎêòÎ©¥ Í∑∏ ÏàòÏ†ïÎêú Í∞íÏúºÎ°ú Îã§Ïãú ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ¥ÏßÄ ÏïäÎäîÎã§.

2. ÌÜ†ÌÅ∞Ïù¥ ÏóÜÎäîÎç∞ÎèÑ, verifyToken Î°úÏßÅÏù¥ ÏûëÎèôÌïòÍ∏∞ Ï†ÑÍπåÏßÄ ÌéòÏù¥ÏßÄÍ∞Ä Ïû†Íπê Î≥¥Ïù∏Îã§.

3. Ïù∏Ï¶ùÏù¥ Ïã§Ìå®ÌñàÎäîÎç∞ÎèÑ, Ïù¥Ï†ÑÏóê Î∞õÏïÑÏò® ÏÑúÎ≤Ñ Îç∞Ïù¥ÌÑ∞ Ï∫êÏãúÍ∞Ä ÎÇ®ÏïÑÏûàÏñ¥ÏÑú Ìï¥Îãπ Îç∞Ïù¥ÌÑ∞Í∞Ä Ïû†Íπê Î≥¥Ïù∏Îã§.


1Î≤à Î¨∏Ï†úÎäî verify ÏøºÎ¶¨Ïùò ÏøºÎ¶¨ ÌÇ§Î•º Î≥ÄÍ≤ΩÌïòÎäî Í≤ÉÏúºÎ°ú Ìï¥Í≤∞Ïù¥ Í∞ÄÎä•ÌïòÎã§, ÏóëÏÑ∏Ïä§ ÌÜ†ÌÅ∞ Í∞íÏóê Îî∞ÎùºÏÑú Í≤∞Í≥ºÍ∞Ä ÏñºÎßàÎì†ÏßÄ Îã¨ÎùºÏßàÏàò ÏûàÎäî ÏøºÎ¶¨Ïù¥Í∏∞ ÎïåÎ¨∏Ïóê, ÎãπÏó∞Ìûà ÏøºÎ¶¨ ÌÇ§Ïóê ÏóëÏÑ∏Ïä§ ÌÜ†ÌÅ∞ Í∞íÎèÑ Ìè¨Ìï®ÏãúÏºúÏ§òÏïº ÌïòÎäî Í≤ÉÏù¥Îã§. 
`verifyToken`
```tsx
import React, { useState } from 'react'
import { useQuery } from 'react-query'
import { refresh, verify } from '../apis/services/auth'
import { getCookie, setCookie } from '../utils/cookies'

type authType = 'PENDING' | 'SUCCESS' | 'FAILED'

function verifyToken() {
  const [isAuthenticated, setIsAuthenticated] = useState<authType>('PENDING')
  const token = getCookie('accessToken')
  // ÏóëÏÑ∏Ïä§ ÌÜ†ÌÅ∞Ïù¥ ÏûàÏùÑ ÎïåÎßå
  const verifyResult = useQuery(['auth', 'verify', token], verify, {
    onSuccess: () => {
      setIsAuthenticated('SUCCESS')
    },
    onError: () => {
      setIsAuthenticated('FAILED')
    },
    retry: 0, // Ïã§Ìå®ÌñàÎçîÎùºÎèÑ Îã§Ïãú ÏöîÏ≤≠ÌïòÏßÄ ÏïäÏùå
    enabled: !!token, // ÏóëÏÑ∏Ïä§ ÌÜ†ÌÅ∞Ïù¥ ÏûàÏùÑ ÎïåÎßå verify
  })
  // ÏóëÏÑ∏Ïä§ ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏùÑ ÎïåÎßå
  // Í∞ÄÎä•ÌïòÎã§Î©¥, refresh token Ïùò Ï°¥Ïû¨ Ïó¨Î∂ÄÎ•º Ïø†ÌÇ§ ÌòπÏùÄ redux ÏÉÅÌÉúÎ°ú Í¥ÄÎ¶¨ÌïòÎ©¥ÏÑú Ìï®Íªò Ïç®Ï£ºÎäîÍ≤å Ï¢ãÏùå
  const refreshResult = useQuery(['auth', 'refresh'], refresh, {
    onSuccess: (data) => {
      setCookie('accessToken', data.accessToken, { path: '/', maxAge: data.exp - data.iat })
      setIsAuthenticated('SUCCESS')
    },
    onError: () => {
      setIsAuthenticated('FAILED')
    },
    retry: 0, // Ïã§Ìå®ÌñàÎçîÎùºÎèÑ Îã§Ïãú ÏöîÏ≤≠ÌïòÏßÄ ÏïäÏùå
    enabled: !token, // ÏóëÏÑ∏Ïä§ ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏùÑ ÎïåÎßå refresh
  })

  return isAuthenticated // Ïù∏Ï¶ù Ïó¨Î∂Ä Í∞íÏùÑ Î¶¨ÌÑ¥Ìï¥ÏÑú ÏÇ¨Ïö©
}

export default verifyToken
```

2Î≤à Î¨∏Ï†úÎäî router ÏóêÏÑú Ï°∞Í±¥Î∂Ä Î†åÎçîÎßÅÏùÑ Ìï¥Ï£ºÎäî Í≤ÉÏúºÎ°ú Ìï¥Í≤∞Ìï†Ïàò ÏûàÎã§.

ÏóëÏÑ∏Ïä§ ÌÜ†ÌÅ∞Ïù¥ ÏóÜÏúºÎ©¥ Î¨¥Ï°∞Í±¥ Ïª¥Ìè¨ÎÑåÌä∏Î•º Ïà®Í∏∞Îêò, ÌòπÏãúÎÇò ÌÜ†ÌÅ∞Ïù¥ Î¶¨ÌîÑÎ†àÏâ¨ Îê†Ïàò ÏûàÏúºÎØÄÎ°ú Ïù∏Ï¶ùÏù¥ ÎêòÎäî ÏàúÍ∞Ñ Îã§Ïãú Ìï¥Îãπ ÌéòÏù¥ÏßÄÎ•º Î≥¥Ïó¨Ï£ºÎ©¥ ÎêúÎã§.

ÌÜ†ÌÅ∞Ïù¥ ÏûàÎã§Î©¥ ÏùºÎã® Ïª¥Ìè¨ÎÑåÌä∏Î•º Î≥¥Ïó¨Ï£ºÏßÄÎßå, Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÌÜ†ÌÅ∞Ïùº Í≤ΩÏö∞ ÎÇ¥Î∂ÄÏª¥Ìè¨ÎÑåÌä∏ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ¥ÎçîÎùºÎèÑ Î∞±ÏóîÎìúÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º ÏùëÎãµÌï¥Ï£ºÏßÄ ÏïäÏùÑ Í≤ÉÏù¥Í∏∞Ïóê ÎØºÍ∞êÌïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÌëúÏãúÎê† ÏùºÏùÄ ÏóÜÎã§.

(Îã§Îßå ÎßåÏïΩ Î∞±ÏóîÎìúÏóêÏÑú ÏöîÏ≤≠ÏùÑ Í±∞Î∂ÄÌïòÏßÄ ÏïäÍ≥† Îç∞Ïù¥ÌÑ∞Î•º ÎÇ¥Î†§Ï§ÄÎã§Î©¥ Ïû†Íπê ÌëúÏãúÎê†Ïàò ÏûàÎã§.)
`ProtectedRouter`
```tsx
import React, { useEffect } from 'react'
import verifyToken from '../hooks/verifyToken'
import { getCookie } from '../utils/cookies'
import { Outlet, useNavigate } from 'react-router-dom'

export default function ProtectedRouter() {
    const navigate = useNavigate()
    const token = getCookie('accessToken')
    const isAuthenticated = verifyToken()

    useEffect(() => {
        if (isAuthenticated === 'FAILED') {
            //ÌÜ†ÌÅ∞Ïù¥ ÏóÜÍ±∞ÎÇò, Ïù∏Ï¶ù Ïã§Ìå® Ïãú Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú
            alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§')
            navigate('/login')
        }
    }, [isAuthenticated])

    // ÌÜ†ÌÅ∞Ïù¥ ÏóÜÎã§Î©¥ verifyToken Ïù¥ ÏûëÎèôÌï† ÎïåÍπåÏßÄ Ïû†Ïãú Ïª¥Ìè¨ÎÑåÌä∏Î•º Ïà®ÍπÄ
    // ÌÜ†ÌÅ∞Ïù¥ ÏûàÏúºÎ©¥ verifyToken ÏûëÎèô Ï†ÑÏù¥ÎùºÎèÑ ÏùºÎã® Ïª¥Ìè¨ÎÑåÌä∏Î•º Î≥¥Ïó¨Ï£ºÎêò
    // ÎßåÏïΩ Í∑∏Í≤å ÏûòÎ™ªÎêú ÎÖÄÏÑùÏù¥ÎùºÎ©¥, Î∞±ÏóîÎìúÏóê ÏöîÏ≤≠ÏùÑ Î™ªÎ≥¥ÎÇ¥Í∏∞Ïóê Ïª®ÌÖêÏ∏†Î•º Î≥ºÏàòÎäî ÏóÜÎã§.
    if (!token && isAuthenticated !== 'SUCCESS') return <>Î°úÎî© Ï§ë</>
    return <Outlet />
}

```

ÎßàÏßÄÎßâÏúºÎ°ú 3Î≤àÏùÄ queryClientÏùò Ï∫êÏãúÎ•º ÏÇ≠Ï†úÌïòÎäî Í≤ÉÏúºÎ°ú Ìï¥Í≤∞Ìï†Ïàò ÏûàÎã§.

```tsx
import React, { useEffect } from 'react'
import verifyToken from '../hooks/verifyToken'
import { getCookie } from '../utils/cookies'
import { Outlet, useNavigate } from 'react-router-dom'
import { useQueryClient } from 'react-query'

export default function ProtectedRouter() {
    const queryClient = useQueryClient()
    const navigate = useNavigate()
    const token = getCookie('accessToken')
    const isAuthenticated = verifyToken()

    useEffect(() => {
        if (isAuthenticated === 'FAILED') {
            queryClient.clear() // Ï∫êÏãú ÏÇ≠Ï†ú
            // Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ access token Ïù¥ÎùºÎ©¥ removeCookie Î°ú ÏÇ≠Ï†ú ÌïÑÏöî
            // Îã§Îßå refresh token (httponly cookie) ÏÇ≠Ï†úÎäî ÏÑúÎ≤ÑÏ™ΩÏóêÏÑú Ìï¥ÏïºÌïúÎã§.

            // Ïù¥Ï†ú ÌÜ†ÌÅ∞Ïù¥ ÏûàÎì† ÏóÜÎì† isAuthenticated Îäî Í∞íÏù¥ set ÎêòÎØÄÎ°ú token ÏùÄ Ï°∞Í±¥Î¨∏Ïóê Ï†úÏô∏
            alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§')
            navigate('/login')
        }
    }, [isAuthenticated])

    // ÌÜ†ÌÅ∞Ïù¥ ÏóÜÎã§Î©¥ verifyToken Ïù¥ ÏûëÎèôÌï† ÎïåÍπåÏßÄ Ïû†Ïãú Ïª¥Ìè¨ÎÑåÌä∏Î•º Ïà®ÍπÄ
    // ÌÜ†ÌÅ∞Ïù¥ ÏûàÏúºÎ©¥ verifyToken ÏûëÎèô Ï†ÑÏù¥ÎùºÎèÑ ÏùºÎã® Ïª¥Ìè¨ÎÑåÌä∏Î•º Î≥¥Ïó¨Ï£ºÎêò
    // ÎßåÏïΩ Í∑∏Í≤å ÏûòÎ™ªÎêú ÎÖÄÏÑùÏù¥ÎùºÎ©¥, Î∞±ÏóîÎìúÏóê ÏöîÏ≤≠ÏùÑ Î™ªÎ≥¥ÎÇ¥Í∏∞Ïóê Ïª®ÌÖêÏ∏†Î•º Î≥ºÏàòÎäî ÏóÜÎã§.
    if (!token && isAuthenticated !== 'SUCCESS') return <>Î°úÎî© Ï§ë</>
    return <Outlet />
}

```



